# Echo Command - 系统架构设计文档

## 一、核心设计思想

本架构采用"本地核心 + 云端大脑"的混合模式：

- **本地核心 (Local Core)**: 部署在用户设备上，负责所有需要即时响应的实时任务，如语音识别和系统命令执行。其首要目标是**极致的低延迟**，确保用户体验流畅。

- **云端大脑 (Cloud Brain)**: 部署在云服务器上，负责所有需要持久化、跨设备同步、数据分析和高计算量的任务。其首要目标是**数据的可靠性、一致性和系统的可扩展性**。

## 二、详细架构图

```mermaid
graph TD
    subgraph "用户设备 (Client Device)"
        style "用户设备 (Client Device)" fill:#e6f3ff,stroke:#333,stroke-width:2px,color:#333

        A[
            <b>前端应用 (Electron+Vue.js)</b>
            <br/>
            <i>- UI渲染与状态管理</i>
            <i>- 麦克风音频捕获</i>
            <i>- 本地配置存储</i>
        ]

        B[
            <b>本地核心后端 (Python/FastAPI)</b>
            <br/>
            <i>- 实时AI处理 (STT/LLM/TTS)</i>
            <i>- 系统命令执行</i>
            <i>- 云端API代理与事件上报</i>
        ]

        C[<b>操作系统 API (OS API)</b><br><i>文件/应用/音量控制</i>]

        A -- "<b>WebSocket</b><br>(实时音频与指令)" --> B
        B -- "<b>本地函数调用</b><br>(毫秒级响应)" --> C
    end

    subgraph "云端服务 (Cloud Services)"
        style "云端服务 (Cloud Services)" fill:#fff5e6,stroke:#333,stroke-width:2px,color:#333

        E[<b>API 网关 (API Gateway)</b><br><i>认证、路由、限流</i>]

        subgraph "<b>微服务应用层 (Java/Spring Boot)</b>"
            G[<b>用户与认证服务</b><br><i>管理用户、签发Token</i>]
            H[<b>配置与指令服务</b><br><i>管理用户设置与自定义宏</i>]
        end

        subgraph "<b>数据持久层 (Data Persistence)</b>"
            I[
                <b>MySQL 数据库</b>
                <br/>
                <i>- 用户账户</i>
                <i>- 指令库</i>
                <i>- 持久化配置</i>
            ]
            J[
                <b>Redis 缓存集群</b>
                <br/>
                <i>- 用户会话 (Session)</i>
                <i>- 热点数据缓存</i>
                <i>- 分布式锁</i>
            ]
        end

        subgraph "<b>异步处理与数据管道</b>"
            K((
                <b>Kafka 消息队列</b>
                <br/>
                <i>- 行为日志</i>
                <i>- 性能指标</i>
                <i>- AI反馈数据</i>
            ))
            L[<b>数据消费与分析服务</b><br><i>(Flink/Spark/Java)</i>]
            M[<b>数据仓库 (Data Warehouse)</b><br><i>用于BI与模型分析</i>]
        end

        E --> G & H
        G & H -- "JDBC" --> I
        G & H -- "TCP" --> J
        K -- "事件流" --> L
        L -- "ETL" --> M
    end

    B -- "<b>HTTPS/REST API</b><br>(用户登录, 配置同步)" --> E
    B -- "<b>TCP/IP (异步)</b><br>(行为/日志事件上报)" --> K
```

## 三、架构组件职责详解

### 3.1. 用户设备端组件

#### 前端应用 (Electron+Vue.js)
- **定位**: 系统的用户界面和交互入口
- **职责**: 
  - 渲染系统托盘图标、状态悬浮窗和设置页面
  - 通过标准接口访问麦克风捕获音频
  - 管理UI的实时状态（如"正在聆听"）
  - 通过WebSocket协议与本地后端进行低延迟的双向通信

#### 本地核心后端 (Python/FastAPI)
- **定位**: 负责实时指令处理的本地服务器
- **职责**:
  - 协调完成一次语音交互的完整AI处理流程（语音转文本、意图理解、文本转语音）
  - 解析AI模型返回的指令，并将其转换为对操作系统API的直接调用
  - 作为云端服务的代理，负责发起用户登录、配置同步等同步请求
  - 上报用户行为等异步事件

#### 操作系统 API
- **定位**: 系统能力的直接执行者
- **职责**: 提供底层能力接口，供本地后端调用以实现打开应用程序、调节系统音量、模拟键盘输入等具体操作

### 3.2. 云端服务组件

#### API 网关 (API Gateway)
- **定位**: 所有云端服务的统一入口和安全屏障
- **职责**:
  - 校验所有传入请求的身份凭证（Token）
  - 根据请求路径将其转发到相应的后端微服务
  - 实施统一的速率限制和访问控制策略
  - 记录所有API调用的审计日志

#### 微服务应用层 (Java/Spring Boot)
- **用户与认证服务**: 负责处理所有与用户账户相关的业务逻辑，包括注册、登录验证、密码管理，并在用户成功登录后签发用于身份验证的凭证（Token）
- **配置与指令服务**: 负责处理用户的个性化配置和自定义指令（宏）的创建、读取、更新和删除。同时，也承载指令社区的分享与发现功能

#### 数据持久层
- **MySQL 数据库**: 作为系统的权威数据源，以结构化的方式永久存储核心业务数据
  - 主要数据表: 包含`用户表`（存储账户信息）、`用户设置表`（存储个性化配置）、以及`自定义指令表`（存储用户创建的宏指令及其执行步骤）
- **Redis 缓存集群**: 作为高性能的内存数据库，用于加速数据访问并降低主数据库的负载
  - 主要用途: 缓存用户的登录状态（会话）；缓存频繁读取但不经常变更的数据（如用户配置）；在分布式环境中实现锁机制，以防止并发操作导致的数据不一致

#### 异步处理与数据管道
- **Kafka 消息队列**: 系统的异步通信总线，用于解耦实时业务和后台批量处理业务
  - 主要用途: 本地后端将用户行为、指令执行日志、性能指标等数据作为事件消息发送到Kafka，这个过程不会阻塞主流程
- **数据消费与分析服务**: 订阅Kafka中的事件流，进行实时的清洗、聚合和转换
- **数据仓库**: 经过处理后的数据最终被存入数据仓库，用于后续的商业智能（BI）报表、用户行为分析以及AI模型的迭代优化

## 四、关键交互流程描述

### 流程一：执行实时指令（本地为主）

1. 用户发出语音指令。前端应用捕获音频并通过WebSocket实时传送给本地后端
2. 本地后端协调AI服务完成识别和理解，得到一个结构化的执行指令
3. 本地后端立即调用操作系统API执行该指令，同时协调AI服务生成语音回应
4. 回应的音频通过WebSocket传回前端播放给用户
5. 指令执行完毕后，本地后端异步地将一条描述此次交互的事件消息发送到云端的Kafka队列中

**特点**: 整个核心交互在本地闭环，响应极快。数据上报是异步的，不影响用户体验。

### 流程二：同步自定义指令（云端交互）

1. 用户在前端应用的设置页面创建或修改了一条宏指令
2. 前端将指令数据提交给本地后端
3. 本地后端通过HTTPS协议向云端API网关发起一个REST API请求
4. 网关验证身份后，将请求路由到配置与指令服务
5. 该服务处理业务逻辑，将更新后的数据写入MySQL数据库，并使Redis中相关的缓存失效
6. 云端服务返回操作成功的响应。本地后端收到响应后，更新其内存中的配置，并通知前端刷新UI

**特点**: 这是一个同步的、需要确认结果的流程，确保了用户数据的可靠存储和跨设备一致性。

## 五、技术选型理由

### 前端技术选型
- **Electron**: 跨平台桌面应用开发，支持Web技术栈
- **Vue.js 3**: 响应式框架，组件化开发，学习成本低
- **Pinia**: 现代化状态管理，TypeScript支持好

### 后端技术选型
- **Python**: AI生态丰富，开发效率高
- **FastAPI**: 高性能异步框架，自动API文档生成
- **WebSocket**: 实时双向通信，适合语音交互

### AI服务选型
- **OpenAI GPT-4o**: 强大的函数调用能力，中文支持好
- **Whisper**: 开源语音识别，准确率高
- **TTS**: 文本转语音，支持多种声音

## 六、性能与扩展性考虑

### 性能优化
- 本地AI处理减少网络延迟
- 异步事件上报不阻塞主流程
- Redis缓存热点数据
- 连接池管理数据库连接

### 扩展性设计
- 微服务架构支持水平扩展
- 消息队列解耦服务依赖
- 容器化部署支持弹性伸缩
- 数据库读写分离

## 七、安全考虑

### 数据安全
- API Token认证
- HTTPS加密传输
- 敏感数据本地存储加密
- 用户数据访问权限控制

### 系统安全
- 输入验证和过滤
- SQL注入防护
- XSS攻击防护
- 系统命令执行沙箱化

## 八、监控与运维

### 监控指标
- 系统性能指标（CPU、内存、网络）
- 业务指标（用户活跃度、指令执行成功率）
- AI服务指标（识别准确率、响应时间）

### 日志管理
- 结构化日志记录
- 日志聚合和分析
- 错误追踪和告警
- 审计日志保存

## 九、未来规划

### 短期目标（3个月）
- 完成核心功能开发
- 基础系统控制实现
- 用户界面优化

### 中期目标（6个月）
- 高级功能开发
- 性能优化
- 多平台支持

### 长期目标（1年）
- 云端服务完善
- 数据分析平台
- 社区功能建设

