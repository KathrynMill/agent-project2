<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è¯­éŸ³åŠ©æ‰‹ - AI Voice Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .demo-badge {
            display: inline-block;
            background: #ffd700;
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
            font-weight: bold;
        }

        .main-area {
            margin-bottom: 30px;
        }

        .voice-button-container {
            text-align: center;
            margin: 30px 0;
        }

        .voice-button {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .voice-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        .voice-button.recording {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .voice-icon {
            width: 60px;
            height: 60px;
            fill: white;
        }

        .input-area {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .text-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-area {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            min-height: 60px;
        }

        .status-text {
            color: #666;
            font-size: 14px;
        }

        .status-text.success {
            color: #4caf50;
        }

        .status-text.error {
            color: #f44336;
        }

        .conversation-area {
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
            border-radius: 10px;
            margin-top: 20px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.assistant {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .message-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .message-content {
            font-size: 15px;
            line-height: 1.5;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .feature-card {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s;
        }

        .feature-card:hover {
            background: #667eea;
            color: white;
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 30px;
            margin-bottom: 10px;
        }

        .feature-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .feature-desc {
            font-size: 13px;
            opacity: 0.8;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .examples {
            margin-top: 20px;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .examples h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .example-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .example-item:hover {
            background: #667eea;
            color: white;
            transform: translateX(5px);
        }
    </style>
  </head>
  <body>
    <div class="container">
        <div class="header">
            <h1>ğŸ™ï¸ æ™ºèƒ½è¯­éŸ³åŠ©æ‰‹</h1>
            <p>åŸºäºå¤§æ¨¡å‹çš„è¯­éŸ³å¯¹è¯ç³»ç»Ÿ</p>
            <span class="demo-badge" id="demoModeBadge" style="display: none;">æ¼”ç¤ºæ¨¡å¼</span>
        </div>

        <div class="main-area">
            <!-- è¯­éŸ³æŒ‰é’® -->
            <div class="voice-button-container">
                <button class="voice-button" id="voiceButton" title="ç‚¹å‡»å¼€å§‹è¯­éŸ³è¾“å…¥">
                    <svg class="voice-icon" viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                </button>
                <p id="voiceStatus" style="margin-top: 15px; color: #666;">
                    ğŸ™ï¸ <strong>ç‚¹å‡»</strong>=å®æ—¶è¯†åˆ«ï¼ˆå…è´¹å¯èƒ½è¢«å¢™ï¼‰ | <strong>é•¿æŒ‰</strong>=å½•éŸ³è¯†åˆ«ï¼ˆè®¯é£ç¨³å®šï¼‰<br>
                    <span style="font-size: 12px;">æˆ–ç›´æ¥åœ¨ä¸‹æ–¹è¾“å…¥æ¡†è¾“å…¥æ–‡å­—</span>
                </p>
            </div>

            <!-- æ–‡æœ¬è¾“å…¥ -->
            <div class="input-area">
                <input type="text" class="text-input" id="textInput" placeholder="æˆ–è€…åœ¨è¿™é‡Œè¾“å…¥æ–‡å­—æŒ‡ä»¤..." />
                <button class="send-button" id="sendButton">å‘é€</button>
            </div>

            <!-- çŠ¶æ€æ˜¾ç¤º -->
            <div class="status-area">
                <div class="status-text" id="statusText">ç­‰å¾…è¾“å…¥...</div>
            </div>

            <!-- å¯¹è¯åŒºåŸŸ -->
            <div class="conversation-area" id="conversationArea">
                <div class="message assistant">
                    <div class="message-label">AIåŠ©æ‰‹</div>
                    <div class="message-content">
                        ä½ å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½è¯­éŸ³åŠ©æ‰‹ã€‚<br><br>
                        <strong>ğŸ’¡ é‡è¦æç¤ºï¼š</strong><br>
                        ç”±äºChromeè¯­éŸ³è¯†åˆ«éœ€è¦GoogleæœåŠ¡ï¼ˆå›½å†…å—é™ï¼‰ï¼Œå»ºè®®æ‚¨ï¼š<br>
                        1ï¸âƒ£ <strong>ç‚¹å‡»ä¸‹æ–¹ç¤ºä¾‹å¡ç‰‡</strong>å¿«é€Ÿæµ‹è¯•<br>
                        2ï¸âƒ£ <strong>åœ¨è¾“å…¥æ¡†è¾“å…¥æ–‡å­—</strong>è¿›è¡Œæµ‹è¯•<br><br>
                        ç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯<strong>å¤§æ¨¡å‹ç†è§£å’Œæ‰§è¡Œ</strong>ï¼Œæ–‡å­—è¾“å…¥å®Œå…¨æœ‰æ•ˆï¼
                    </div>
                </div>
            </div>

            <!-- ç¤ºä¾‹æŒ‡ä»¤ -->
            <div class="examples">
                <h3>ğŸ’¡ è¯•è¯•è¿™äº›æŒ‡ä»¤ï¼ˆç‚¹å‡»å¿«é€Ÿæµ‹è¯•ï¼‰</h3>
                <div class="example-item" onclick="sendExample('å¸®æˆ‘æ‰“å¼€GitHub')">ğŸŒ å¸®æˆ‘æ‰“å¼€GitHub</div>
                <div class="example-item" onclick="sendExample('æ’­æ”¾å‘¨æ°ä¼¦çš„ç¨»é¦™')">ğŸµ æ’­æ”¾å‘¨æ°ä¼¦çš„ç¨»é¦™</div>
                <div class="example-item" onclick="sendExample('å†™ä¸€ç¯‡å…³äºäººå·¥æ™ºèƒ½çš„æ–‡ç« ')">ğŸ“ å†™ä¸€ç¯‡å…³äºäººå·¥æ™ºèƒ½çš„æ–‡ç« </div>
                <div class="example-item" onclick="sendExample('å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªPythonå‡½æ•°')">ğŸ’» å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªPythonå‡½æ•°</div>
                <div class="example-item" onclick="sendExample('æœç´¢æœºå™¨å­¦ä¹ æ•™ç¨‹')">ğŸ” æœç´¢æœºå™¨å­¦ä¹ æ•™ç¨‹</div>
                <p style="margin-top: 10px; font-size: 13px; color: #666;">
                    âš ï¸ å¦‚æœè¯­éŸ³è¯†åˆ«å¤±è´¥ï¼ˆç½‘ç»œé—®é¢˜ï¼‰ï¼Œè¯·ç›´æ¥ç‚¹å‡»ä¸Šé¢çš„ç¤ºä¾‹æˆ–åœ¨è¾“å…¥æ¡†è¾“å…¥æ–‡å­—æµ‹è¯•
                </p>
            </div>
        </div>

        <!-- åŠŸèƒ½ç‰¹æ€§ -->
        <div class="features">
            <div class="feature-card">
                <div class="feature-icon">ğŸ¤</div>
                <div class="feature-title">è¯­éŸ³è¯†åˆ«</div>
                <div class="feature-desc">å®æ—¶è¯­éŸ³è½¬æ–‡å­—</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸ§ </div>
                <div class="feature-title">æ™ºèƒ½ç†è§£</div>
                <div class="feature-desc">æ·±åº¦è¯­ä¹‰åˆ†æ</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸ”§</div>
                <div class="feature-title">ç³»ç»Ÿæ§åˆ¶</div>
                <div class="feature-desc">æ‰§è¡Œå„ç±»æ“ä½œ</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸ”Š</div>
                <div class="feature-title">è¯­éŸ³åˆæˆ</div>
                <div class="feature-desc">è‡ªç„¶è¯­éŸ³æ’­æŠ¥</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8090';
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡çŠ¶æ€
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${API_BASE}/api/info`);
                const data = await response.json();
                
                if (data.demo_mode) {
                    document.getElementById('demoModeBadge').style.display = 'inline-block';
                }
                
                updateStatus('âœ… æœåŠ¡è¿æ¥æˆåŠŸ', 'success');
            } catch (error) {
                updateStatus('âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', 'error');
            }
        });

        // è¯­éŸ³æŒ‰é’®äº‹ä»¶ - ç‚¹å‡»=æµè§ˆå™¨è¯†åˆ«ï¼Œé•¿æŒ‰=è®¯é£å½•éŸ³
        let longPressTimer = null;
        let isLongPress = false;
        
        const voiceBtn = document.getElementById('voiceButton');
        
        voiceBtn.addEventListener('mousedown', function() {
            isLongPress = false;
            // é•¿æŒ‰500msåè§¦å‘å½•éŸ³
            longPressTimer = setTimeout(() => {
                isLongPress = true;
                if (!isRecording) {
                    startRecording(); // è®¯é£å½•éŸ³
                }
            }, 500);
        });
        
        voiceBtn.addEventListener('mouseup', function() {
            clearTimeout(longPressTimer);
            
            if (isLongPress && isRecording) {
                // é•¿æŒ‰åæ¾å¼€ï¼Œåœæ­¢å½•éŸ³
                stopRecording();
            } else if (!isLongPress && !isRecording) {
                // å¿«é€Ÿç‚¹å‡»ï¼Œä½¿ç”¨æµè§ˆå™¨å®æ—¶è¯†åˆ«
                recognizeWithBrowser();
            }
        });
        
        voiceBtn.addEventListener('mouseleave', function() {
            clearTimeout(longPressTimer);
            if (isLongPress && isRecording) {
                stopRecording();
            }
        });

        // æ–‡æœ¬å‘é€æŒ‰é’®
        document.getElementById('sendButton').addEventListener('click', sendTextMessage);

        // å›è½¦å‘é€
        document.getElementById('textInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendTextMessage();
            }
        });

        // åˆ‡æ¢è¯­éŸ³å½•åˆ¶
        async function toggleVoiceRecording() {
            // ç›´æ¥ä½¿ç”¨æµè§ˆå™¨è¯­éŸ³è¯†åˆ«ï¼Œä¸å½•éŸ³
            recognizeWithBrowser();
        }

        // å¼€å§‹å½•éŸ³ - å½•åˆ¶WAVæ ¼å¼ç»™è®¯é£
        async function startRecording() {
            try {
                updateStatus('ğŸ™ï¸ æ­£åœ¨å¯åŠ¨å½•éŸ³...', '');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                // ä½¿ç”¨AudioContextå½•åˆ¶PCMæ•°æ®
                const audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000
                });
                const source = audioContext.createMediaStreamSource(stream);
                const processor = audioContext.createScriptProcessor(4096, 1, 1);
                
                const audioData = [];
                
                processor.onaudioprocess = (e) => {
                    const inputData = e.inputBuffer.getChannelData(0);
                    // è½¬æ¢ä¸º16ä½PCM
                    const pcmData = new Int16Array(inputData.length);
                    for (let i = 0; i < inputData.length; i++) {
                        const s = Math.max(-1, Math.min(1, inputData[i]));
                        pcmData[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }
                    audioData.push(pcmData);
                };
                
                source.connect(processor);
                processor.connect(audioContext.destination);
                
                // ä¿å­˜å¼•ç”¨ä»¥ä¾¿åœæ­¢
                window.audioRecordingData = {
                    stream: stream,
                    audioContext: audioContext,
                    processor: processor,
                    source: source,
                    audioData: audioData
                };
                
                isRecording = true;
                document.getElementById('voiceButton').classList.add('recording');
                updateStatus('ğŸ™ï¸ æ­£åœ¨å½•éŸ³...ï¼ˆæ¾å¼€æŒ‰é’®åœæ­¢ï¼‰', '');

            } catch (error) {
                console.error('å½•éŸ³å¤±è´¥:', error);
                updateStatus('âŒ æ— æ³•è®¿é—®éº¦å…‹é£', 'error');
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼\n\nè¯·ç¡®ä¿ï¼š\n1. æµè§ˆå™¨å·²å…è®¸éº¦å…‹é£æƒé™\n2. ä½¿ç”¨ HTTPS æˆ– localhost\n3. éº¦å…‹é£è®¾å¤‡æ­£å¸¸å·¥ä½œ\n\nğŸ’¡ æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥è¾“å…¥æ–‡å­—æµ‹è¯•');
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (isRecording && window.audioRecordingData) {
                const data = window.audioRecordingData;
                
                // åœæ­¢å½•éŸ³
                data.processor.disconnect();
                data.source.disconnect();
                data.audioContext.close();
                data.stream.getTracks().forEach(track => track.stop());
                
                // åˆå¹¶æ‰€æœ‰PCMæ•°æ®
                let totalLength = 0;
                data.audioData.forEach(arr => {
                    totalLength += arr.length;
                });
                
                const mergedData = new Int16Array(totalLength);
                let offset = 0;
                data.audioData.forEach(arr => {
                    mergedData.set(arr, offset);
                    offset += arr.length;
                });
                
                // åˆ›å»ºWAVæ–‡ä»¶
                const wavBlob = createWavBlob(mergedData, 16000);
                
                isRecording = false;
                document.getElementById('voiceButton').classList.remove('recording');
                
                // å¤„ç†å½•éŸ³
                processVoiceInput(wavBlob);
                
                // æ¸…ç†
                delete window.audioRecordingData;
            }
        }
        
        // åˆ›å»ºWAVæ ¼å¼çš„Blob
        function createWavBlob(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const blockAlign = numChannels * bitsPerSample / 8;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.length * 2;
            
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            
            // WAVå¤´
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);  // fmt chunk size
            view.setUint16(20, 1, true);   // PCM format
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);
            
            // PCMæ•°æ®
            const offset = 44;
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(offset + i * 2, pcmData[i], true);
            }
            
            return new Blob([buffer], { type: 'audio/wav' });
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // å¤„ç†è¯­éŸ³è¾“å…¥ - ä¸Šä¼ åˆ°è®¯é£ASR
        async function processVoiceInput(audioBlob) {
            try {
                updateStatus('ğŸ”„ æ­£åœ¨è¯†åˆ«è¯­éŸ³...', '');
                
                // å°†éŸ³é¢‘è½¬æ¢ä¸ºbase64
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                
                reader.onloadend = async function() {
                    const base64Audio = reader.result;
                    
                    // ä¸Šä¼ åˆ°æœåŠ¡å™¨è¿›è¡Œè®¯é£ASRè¯†åˆ«
                    const response = await fetch(`${API_BASE}/api/voice`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            audio_data: base64Audio,
                            format: 'wav',
                            rate: 16000
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // è¯†åˆ«æˆåŠŸï¼Œæ˜¾ç¤ºç»“æœ
                        if (result.recognized_text) {
                            addMessage(result.recognized_text, 'user');
                        }
                        handleResponse(result);
                    } else {
                        updateStatus(`âŒ è¯†åˆ«å¤±è´¥: ${result.error}`, 'error');
                        alert(`è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼š${result.error}\n\næ‚¨å¯ä»¥ç›´æ¥åœ¨è¾“å…¥æ¡†è¾“å…¥æ–‡å­—`);
                    }
                };
                
                reader.onerror = function() {
                    updateStatus('âŒ éŸ³é¢‘å¤„ç†å¤±è´¥', 'error');
                    alert('éŸ³é¢‘å¤„ç†å¤±è´¥\nè¯·ç›´æ¥åœ¨è¾“å…¥æ¡†è¾“å…¥æ–‡å­—');
                };
                
            } catch (error) {
                console.error('è¯­éŸ³å¤„ç†å¤±è´¥:', error);
                updateStatus('âŒ å¤„ç†å¤±è´¥', 'error');
                alert('è¯­éŸ³å¤„ç†å¤±è´¥\nè¯·ç›´æ¥åœ¨è¾“å…¥æ¡†è¾“å…¥æ–‡å­—');
            }
        }
        
        // ä½¿ç”¨æµè§ˆå™¨å†…ç½®è¯­éŸ³è¯†åˆ«ï¼ˆå®æ—¶è¯†åˆ«ï¼Œä¸éœ€è¦å½•éŸ³ï¼‰
        function recognizeWithBrowser() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«\n\nè¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨\næˆ–è€…ç›´æ¥åœ¨è¾“å…¥æ¡†è¾“å…¥æ–‡å­—');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            
            recognition.onstart = function() {
                console.log('è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨');
                updateStatus('ğŸ™ï¸ è¯·è¯´è¯...', '');
                document.getElementById('voiceButton').classList.add('recording');
            };
            
            recognition.onresult = function(event) {
                const text = event.results[0][0].transcript;
                const confidence = event.results[0][0].confidence;
                console.log('è¯†åˆ«ç»“æœ:', text, 'ç½®ä¿¡åº¦:', confidence);
                
                addMessage(text, 'user');
                updateStatus('AIç†è§£ä¸­...', '');
                document.getElementById('voiceButton').classList.remove('recording');
                
                // å‘é€è¯†åˆ«å‡ºçš„æ–‡å­—åˆ°æœåŠ¡å™¨
                fetch(`${API_BASE}/api/text`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: text })
                })
                .then(response => response.json())
                .then(result => handleResponse(result))
                .catch(error => {
                    console.error('å¤„ç†å¤±è´¥:', error);
                    updateStatus('âŒ å¤„ç†å¤±è´¥', 'error');
                });
            };
            
            recognition.onerror = function(event) {
                console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                document.getElementById('voiceButton').classList.remove('recording');
                
                let errorMsg = 'è¯­éŸ³è¯†åˆ«å¤±è´¥';
                if (event.error === 'network') {
                    errorMsg = 'âŒ ç½‘ç»œé”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°è¯­éŸ³è¯†åˆ«æœåŠ¡\n\nå¯èƒ½åŸå› ï¼š\n1. éœ€è¦è®¿é—®GoogleæœåŠ¡ï¼ˆè¢«å¢™ï¼‰\n2. ç½‘ç»œè¿æ¥é—®é¢˜\n\nğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šç›´æ¥åœ¨ä¸‹æ–¹è¾“å…¥æ¡†è¾“å…¥æ–‡å­—';
                } else if (event.error === 'not-allowed') {
                    errorMsg = 'âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»\nè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸ä½¿ç”¨éº¦å…‹é£';
                } else if (event.error === 'no-speech') {
                    errorMsg = 'âŒ æ²¡æœ‰æ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•';
                } else {
                    errorMsg = `âŒ è¯­éŸ³è¯†åˆ«å¤±è´¥: ${event.error}`;
                }
                
                updateStatus(errorMsg, 'error');
                alert(errorMsg + '\n\næ‚¨å¯ä»¥ç›´æ¥åœ¨è¾“å…¥æ¡†è¾“å…¥æ–‡å­—è¿›è¡Œæµ‹è¯•');
            };
            
            recognition.onend = function() {
                console.log('è¯­éŸ³è¯†åˆ«ç»“æŸ');
                document.getElementById('voiceButton').classList.remove('recording');
            };
            
            try {
                recognition.start();
                console.log('æ­£åœ¨å¯åŠ¨è¯­éŸ³è¯†åˆ«...');
            } catch (error) {
                console.error('å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
                updateStatus('âŒ å¯åŠ¨å¤±è´¥', 'error');
                alert('è¯­éŸ³è¯†åˆ«å¯åŠ¨å¤±è´¥\nè¯·ç›´æ¥åœ¨è¾“å…¥æ¡†è¾“å…¥æ–‡å­—');
            }
        }

        // å‘é€æ–‡æœ¬æ¶ˆæ¯
        async function sendTextMessage() {
            const textInput = document.getElementById('textInput');
            const text = textInput.value.trim();

            if (!text) {
                return;
            }

            // æ¸…ç©ºè¾“å…¥æ¡†
            textInput.value = '';

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage(text, 'user');
            updateStatus('å¤„ç†ä¸­...', '');

            try {
                const response = await fetch(`${API_BASE}/api/text`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text })
                });

                const result = await response.json();
                handleResponse(result);

            } catch (error) {
                console.error('å‘é€å¤±è´¥:', error);
                updateStatus('âŒ å‘é€å¤±è´¥', 'error');
                addMessage('æŠ±æ­‰ï¼ŒæœåŠ¡å™¨è¿æ¥å¤±è´¥', 'assistant');
            }
        }

        // å¤„ç†å“åº”
        function handleResponse(result) {
            if (result.success) {
                const message = result.message || result.execution?.message || 'æ“ä½œå®Œæˆ';
                addMessage(message, 'assistant');
                updateStatus('âœ… ' + message, 'success');

                // å¦‚æœæœ‰TTSæ–‡æœ¬ï¼Œå¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨è¯­éŸ³æ’­æŠ¥
                if (result.tts_text) {
                    // speakText(result.tts_text);
                }
            } else {
                const errorMsg = result.error || 'å¤„ç†å¤±è´¥';
                addMessage('æŠ±æ­‰ï¼Œ' + errorMsg, 'assistant');
                updateStatus('âŒ ' + errorMsg, 'error');
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯åŒºåŸŸ
        function addMessage(content, type) {
            const conversationArea = document.getElementById('conversationArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const label = type === 'user' ? 'æˆ‘' : 'AIåŠ©æ‰‹';
            messageDiv.innerHTML = `
                <div class="message-label">${label}</div>
                <div class="message-content">${content}</div>
            `;

            conversationArea.appendChild(messageDiv);
            conversationArea.scrollTop = conversationArea.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€æ–‡æœ¬
        function updateStatus(text, statusClass) {
            const statusElement = document.getElementById('statusText');
            statusElement.textContent = text;
            statusElement.className = `status-text ${statusClass}`;
        }

        // å‘é€ç¤ºä¾‹æŒ‡ä»¤
        function sendExample(text) {
            document.getElementById('textInput').value = text;
            sendTextMessage();
        }
    </script>
  </body>
</html>
