# 🔧 讯飞语音识别修复说明

## ❌ 之前的问题
```
语音识别失败: 讯飞语音识别失败: invalid parameter|invalid audio
```

**原因**：浏览器录制的是 **WebM** 格式，讯飞ASR不支持。

---

## ✅ 修复方案

### 方案：前端录制WAV格式

1. **使用AudioContext录制**
   - 直接录制PCM音频数据
   - 采样率：16kHz
   - 单声道

2. **生成标准WAV文件**
   - 添加44字节WAV头
   - 16位PCM编码
   - 符合讯飞要求

3. **服务器处理**
   - 去除WAV头（44字节）
   - 只发送PCM数据给讯飞
   - 讯飞识别纯PCM数据

---

## 🎯 现在如何使用

### 刷新页面测试

1. **打开浏览器**
   ```
   http://localhost:8090/frontend/
   ```

2. **长按麦克风按钮**（重要！）
   - 不是点击，是**长按**
   - 按住超过0.5秒
   - 看到按钮变紫色

3. **说出指令**
   ```
   "帮我打开GitHub"
   ```

4. **松开按钮**
   - 自动上传到讯飞ASR
   - 等待识别结果

---

## 📊 技术细节

### 录音流程

```
用户长按按钮
   ↓
[AudioContext采集] → 16kHz PCM数据
   ↓
[前端合成WAV] → 添加WAV头
   ↓
[Base64编码] → 上传服务器
   ↓
[服务器去除WAV头] → 纯PCM数据
   ↓
[讯飞ASR] → 识别文字
   ↓
[LLM理解] → 执行操作
```

### 关键代码更新

**前端：**
- ✅ 使用`AudioContext`和`ScriptProcessor`录音
- ✅ 转换Float32为Int16 PCM
- ✅ 生成标准WAV文件（44字节头）

**服务器：**
- ✅ 检测WAV格式
- ✅ 自动去除44字节头
- ✅ 发送纯PCM给讯飞

---

## 🔍 如果还有问题

### 检查麦克风权限
- Chrome → 设置 → 隐私和安全 → 网站设置 → 麦克风
- 确保localhost有权限

### 检查录音时长
- 说话时间：1-10秒
- 太短可能无法识别
- 太长可能超时

### 查看服务器日志
```bash
# 会显示详细的调试信息
📤 讯飞ASR请求参数: {'engine_type': 'sms16k', 'aue': 'raw'}
📊 音频数据大小: xxxxx bytes
📥 讯飞ASR响应: {...}
```

---

## ✨ 三种输入方式对比

| 方式 | 操作 | 优势 | 劣势 |
|------|------|------|------|
| 文字输入 | 输入框 | 最稳定 | 无语音体验 |
| 浏览器识别 | 快速点击 | 免费实时 | 可能被墙 |
| 讯飞识别 | 长按录音 | 稳定可靠 | 需要长按 |

---

## 🎉 现在就测试！

**强烈建议使用讯飞录音（长按）**：
1. 刷新页面
2. **长按**麦克风按钮
3. 说"帮我打开GitHub"
4. 松开按钮
5. 查看识别结果

**如果讯飞还是失败，直接用文字输入测试核心功能！**
系统的核心是AI理解和执行，语音只是输入方式之一！

